# PowerShell Script to Enable WinRM, Disable Protections, and Configure SMB Relay/PtH Attacks
# Author: 4stersec

# Function to run a command and handle errors
function Run-Command {
    param ($Command)
    try {
        Invoke-Expression $Command -ErrorAction Stop
        Write-Host "[+] Successfully executed: $Command" -ForegroundColor Green
    } catch {
        Write-Host "[-] Error executing: $Command" -ForegroundColor Red
    }
}

Write-Host "[*] Starting Windows Configuration for WinRM & Exploits..." -ForegroundColor Cyan

# 1️⃣ Enable WinRM
Write-Host "[*] Enabling WinRM..."
Run-Command "winrm quickconfig -q"
Run-Command "winrm set winrm/config/service '@{AllowUnencrypted=`"true`"}'"
Run-Command "winrm set winrm/config/service/auth '@{Basic=`"true`"}'"

# 2️⃣ Disable NLA (For RDP attacks)
Write-Host "[*] Disabling Network Level Authentication (NLA)..."
Run-Command 'reg add "HKLM\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" /v UserAuthentication /t REG_DWORD /d 0 /f'

# 3️⃣ Enable Pass-the-Hash (PtH) Attacks
Write-Host "[*] Enabling WDigest Authentication for PtH..."
Run-Command 'reg add "HKLM\System\CurrentControlSet\Control\SecurityProviders\WDigest" /v UseLogonCredential /t REG_DWORD /d 1 /f'

# 4️⃣ Disable SMB Signing (Required for SMB Relay)
Write-Host "[*] Disabling SMB Signing..."
Run-Command 'reg add "HKLM\SYSTEM\CurrentControlSet\Services\LanmanServer\Parameters" /v RequireSecuritySignature /t REG_DWORD /d 0 /f'
Run-Command 'reg add "HKLM\SYSTEM\CurrentControlSet\Services\LanmanWorkstation\Parameters" /v RequireSecuritySignature /t REG_DWORD /d 0 /f'

# 5️⃣ Enable SMBv1 (For Older Exploits like EternalBlue)
Write-Host "[*] Enabling SMBv1..."
Run-Command 'sc.exe config lanmanworkstation depend= bowser/mrxsmb10/nsi'
Run-Command 'sc.exe config mrxsmb10 start= auto'

# 6️⃣ Disable Windows Defender & UAC
Write-Host "[*] Disabling Windows Defender & UAC..."
Run-Command 'reg add "HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System" /v EnableLUA /t REG_DWORD /d 0 /f'
Run-Command 'reg add "HKLM\SOFTWARE\Policies\Microsoft\Windows Defender" /v DisableAntiSpyware /t REG_DWORD /d 1 /f'

# 7️⃣ Disable Tamper Protection (Manual Step)
Write-Host "[!] Please disable 'Tamper Protection' manually in Windows Security." -ForegroundColor Yellow

Write-Host "[+] Configuration completed! Reboot required for full effect." -ForegroundColor Green
